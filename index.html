<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Archive Viewer/Enhancer</title>
    <style>
        :root {
            --primary-color: #0066cc;
            --bg-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --hover-color: #f5f5f5;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --error-color: #dc3545;
        }

        .dark-mode {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --border-color: #404040;
            --hover-color: #2a2a2a;
            --primary-color: #66b3ff;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 2.5rem;
            font-weight: 700;
        }

        h2 {
            color: var(--text-color);
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .feature {
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--hover-color);
            transition: transform 0.2s ease;
        }

        .feature:hover {
            transform: translateY(-2px);
        }

        .feature strong {
            color: var(--primary-color);
            display: block;
            margin-bottom: 0.5rem;
        }

        .upload-section {
            background: var(--hover-color);
            padding: 2rem;
            border-radius: 12px;
            border: 2px dashed var(--border-color);
            margin: 2rem 0;
            text-align: center;
            transition: border-color 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--primary-color);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 1rem 0;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            display: inline-block;
            padding: 12px 24px;
            background: var(--primary-color);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: 600;
        }

        .file-input-button:hover {
            background: #0052a3;
        }

        .status {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            font-weight: 600;
            text-align: center;
        }

        .status.loading {
            background: var(--warning-color);
            color: #000;
        }

        .status.success {
            background: var(--success-color);
            color: white;
        }

        .control-panel {
            background: var(--hover-color);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0.5rem;
            font-size: 14px;
        }

        .button-primary {
            background: var(--primary-color);
            color: white;
        }

        .button-primary:hover {
            background: #0052a3;
        }

        .button-secondary {
            background: var(--border-color);
            color: var(--text-color);
        }

        .button-secondary:hover {
            background: var(--hover-color);
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .steps {
            counter-reset: step-counter;
        }

        .steps li {
            counter-increment: step-counter;
            margin: 1rem 0;
            padding-left: 2rem;
            position: relative;
        }

        .steps li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            background: var(--primary-color);
            color: white;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .features {
                grid-template-columns: 1fr;
            }
        }

        /* Dark mode toggle */
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .dark-mode-toggle:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">&#127769;</button>
    
    <div class="container">
        <div id="root">
            <h1>ChatGPT Archive Enhancer Tool</h1>
            <p>Transform your downloaded ChatGPT chat archive with enhanced features for better browsing and searching.</p>
            
            <div class="features">
                <div class="feature">
                    <strong>&#128269; Advanced Search</strong>
                    Use quotes, exclusions (-), and OR operators (/) for powerful search capabilities.
                </div>
                <div class="feature">
                    <strong>&#127769; Smart Dark Mode</strong>
                    Automatic system detection with manual toggle and preference saving.
                </div>
                <div class="feature">
                    <strong>&#128218; Collapsible Chats</strong>
                    Organize and navigate your conversations with expandable sections.
                </div>
                <div class="feature">
                    <strong>üîó Direct Links</strong>
                    Quick access to original conversations on chat.openai.com.
                </div>
            </div>

            <h2>How to Use:</h2>
            <ol class="steps">
                <li><strong>Download your Chats from ChatGPT</strong> - Go to Settings ‚Üí Data Controls ‚Üí Export Data</li>
                <li><strong>Upload Your Chat Archive</strong> - Select the chat.html file from your download</li>
                <li><strong>Save or Open Enhanced File</strong> - Get your improved archive with all enhancements</li>
            </ol>

            <div class="upload-section">
                <h3>üìÅ Upload Your Chat Archive</h3>
                <p>Select your ChatGPT chat.html file to enhance it with improved features.</p>
                
                <form id="upload-form">
                    <div class="file-input-wrapper">
                        <input type="file" id="file-input" class="file-input" accept=".html" required>
                        <label for="file-input" class="file-input-button">Choose Chat Archive File</label>
                    </div>
                </form>

                <div id="status" class="status" style="display:none;"></div>

                <div id="controlPanelAfterUpload" class="control-panel" style="display:none;">
                    <textarea id="editor" rows="20" cols="80" style="display: none;"></textarea>
                    
                    <button id="download-button" class="button button-primary">üíæ Save Enhanced File</button>

                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="markdown" name="markdown" checked>
                        <label for="markdown">Enable Markdown Parsing</label>
                    </div>

                    <button id="open-button" class="button button-secondary">üëÅÔ∏è Preview Enhanced File</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const pre = "PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8bWV0YSBodHRwLWVxdWl2PSJDb250ZW50LVR5cGUiIGNvbnRlbnQ9InRleHQvaHRtbDsgY2hhcnNldD1VVEYtOCI+CiAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCI+CiAgICA8dGl0bGU+Q2hhdEdQVCBBcmNoaXZlIC0gRW5oYW5jZWQ8L3RpdGxlPgogICAgPHN0eWxlPgogICAgICAgIDpyb290IHsKICAgICAgICAgICAgLS1iZy1jb2xvcjogI2ZmZmZmZjsKICAgICAgICAgICAgLS10ZXh0LWNvbG9yOiAjMDAwMDAwOwogICAgICAgICAgICAtLWNvbnZlcnNhdGlvbi1iZzogI2YzZjNmMzsKICAgICAgICAgICAgLS1jb252ZXJzYXRpb24tYm9yZGVyOiAjMDAwMDAwOwogICAgICAgICAgICAtLWNvbnRyb2wtcGFuZWwtYmc6ICNmZmZmZmY7CiAgICAgICAgICAgIC0tY29udHJvbC1wYW5lbC1zaGFkb3c6IHJnYmEoMCwgMCwgMCwgMC4xKTsKICAgICAgICAgICAgLS1idXR0b24tYmc6ICNmMGYwZjA7CiAgICAgICAgICAgIC0tYnV0dG9uLWhvdmVyOiAjZTBlMGUwOwogICAgICAgICAgICAtLXNlYXJjaC1ib3JkZXI6ICNjY2M7CiAgICAgICAgICAgIC0tbGluay1jb2xvcjogIzAwNjZjYzsKICAgICAgICB9CgogICAgICAgIC5kYXJrLW1vZGUgewogICAgICAgICAgICAtLWJnLWNvbG9yOiAjMTIxMjEyOwogICAgICAgICAgICAtLXRleHQtY29sb3I6ICNlMGUwZTA7CiAgICAgICAgICAgIC0tY29udmVyc2F0aW9uLWJnOiAjMWUxZTFlOwogICAgICAgICAgICAtLWNvbnZlcnNhdGlvbi1ib3JkZXI6ICMzMzMzMzM7CiAgICAgICAgICAgIC0tY29udHJvbC1wYW5lbC1iZzogIzJhMmEyYTsKICAgICAgICAgICAgLS1jb250cm9sLXBhbmVsLXNoYWRvdzogcmdiYSgwLCAwLCAwLCAwLjcpOwogICAgICAgICAgICAtLWJ1dHRvbi1iZzogIzQwNDA0MDsKICAgICAgICAgICAgLS1idXR0b24taG92ZXI6ICM1MDUwNTA7CiAgICAgICAgICAgIC0tc2VhcmNoLWJvcmRlcjogIzU1NTU1NTsKICAgICAgICAgICAgLS1saW5rLWNvbG9yOiAjNjZiM2ZmOwogICAgICAgIH0KCiAgICAgICAgKiB7CiAgICAgICAgICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICAgICAgfQoKICAgICAgICBib2R5IHsKICAgICAgICAgICAgbWFyZ2luOiAwOwogICAgICAgICAgICBwYWRkaW5nOiAyMHB4OwogICAgICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1iZy1jb2xvcik7CiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0LWNvbG9yKTsKICAgICAgICAgICAgZm9udC1mYW1pbHk6IC1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgJ1NlZ29lIFVJJywgUm9ib3RvLCBPeHlnZW4sIFVidW50dSwgQ2FudGFyZWxsLCBzYW5zLXNlcmlmOwogICAgICAgICAgICBsaW5lLWhlaWdodDogMS42OwogICAgICAgICAgICB0cmFuc2l0aW9uOiBiYWNrZ3JvdW5kLWNvbG9yIDAuM3MgZWFzZSwgY29sb3IgMC4zcyBlYXNlOwogICAgICAgIH0KCiAgICAgICAgaDQgewogICAgICAgICAgICBmb250LWZhbWlseTogaW5oZXJpdDsKICAgICAgICAgICAgbWFyZ2luOiAwOwogICAgICAgICAgICBmb250LXNpemU6IDEuMWVtOwogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgIH0KCiAgICAgICAgI3Jvb3QgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICAgICAgICBnYXA6IDIwcHg7CiAgICAgICAgICAgIG1hcmdpbi10b3A6IDYwcHg7CiAgICAgICAgfQoKICAgICAgICAuY29udmVyc2F0aW9uIHsKICAgICAgICAgICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tY29udmVyc2F0aW9uLWJvcmRlcik7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgICAgICAgcGFkZGluZzogMjBweDsKICAgICAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tY29udmVyc2F0aW9uLWJnKTsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuM3MgZWFzZTsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCAycHggNHB4IHZhcigtLWNvbnRyb2wtcGFuZWwtc2hhZG93KTsKICAgICAgICB9CgogICAgICAgIC5jb252ZXJzYXRpb246aG92ZXIgewogICAgICAgICAgICBib3gtc2hhZG93OiAwIDRweCA4cHggdmFyKC0tY29udHJvbC1wYW5lbC1zaGFkb3cpOwogICAgICAgIH0KCiAgICAgICAgLmNvbnZlcnNhdGlvbi5jb2xsYXBzZWQgewogICAgICAgICAgICBwYWRkaW5nLWJvdHRvbTogMjBweDsKICAgICAgICB9CgogICAgICAgIC5jb252ZXJzYXRpb24uY29sbGFwc2VkID4gOm5vdChoNCkgewogICAgICAgICAgICBkaXNwbGF5OiBub25lOwogICAgICAgIH0KCiAgICAgICAgLm1lc3NhZ2U6bm90KC5wcmludGFibGUpIGRpdiB7CiAgICAgICAgICAgIHdoaXRlLXNwYWNlOiBwcmUtd3JhcDsKICAgICAgICB9CgogICAgICAgIC5tZXNzYWdlIHsKICAgICAgICAgICAgbWFyZ2luOiAxNnB4IDA7CiAgICAgICAgICAgIHBhZGRpbmc6IDEycHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYmctY29sb3IpOwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1jb252ZXJzYXRpb24tYm9yZGVyKTsKICAgICAgICB9CgogICAgICAgIC5tZXNzYWdlLmNoYXRncHQtbWVzc2FnZSB7CiAgICAgICAgICAgIGJvcmRlci1sZWZ0OiA0cHggc29saWQgIzEwYTM3ZjsKICAgICAgICB9CgogICAgICAgIC5tZXNzYWdlLnVzZXItbWVzc2FnZSB7CiAgICAgICAgICAgIGJvcmRlci1sZWZ0OiA0cHggc29saWQgdmFyKC0tbGluay1jb2xvcik7CiAgICAgICAgfQoKICAgICAgICAuYXV0aG9yIHsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgICAgICAgICBmb250LXNpemU6IDAuOWVtOwogICAgICAgICAgICBjb2xvcjogdmFyKC0tbGluay1jb2xvcik7CiAgICAgICAgfQoKICAgICAgICAuYXV0aG9yOjpmaXJzdC1sZXR0ZXIgewogICAgICAgICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgICAgIH0KCiAgICAgICAgI2NvbnRyb2xQYW5lbCB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgICAgICAgICAgdG9wOiAwOwogICAgICAgICAgICBsZWZ0OiAwOwogICAgICAgICAgICByaWdodDogMDsKICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tY29udHJvbC1wYW5lbC1iZyk7CiAgICAgICAgICAgIHBhZGRpbmc6IDEycHggMjBweDsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCAycHggOHB4IHZhcigtLWNvbnRyb2wtcGFuZWwtc2hhZG93KTsKICAgICAgICAgICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpOwogICAgICAgICAgICB6LWluZGV4OiAxMDAwOwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBnYXA6IDEycHg7CiAgICAgICAgICAgIGZsZXgtd3JhcDogd3JhcDsKICAgICAgICB9CgogICAgICAgICNjb250cm9sUGFuZWwgaW5wdXQgewogICAgICAgICAgICBmbGV4OiAxOwogICAgICAgICAgICBtaW4td2lkdGg6IDIwMHB4OwogICAgICAgICAgICBwYWRkaW5nOiA4cHggMTJweDsKICAgICAgICAgICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tc2VhcmNoLWJvcmRlcik7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYmctY29sb3IpOwogICAgICAgICAgICBjb2xvcjogdmFyKC0tdGV4dC1jb2xvcik7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgICB9CgogICAgICAgICNjb250cm9sUGFuZWwgYnV0dG9uIHsKICAgICAgICAgICAgcGFkZGluZzogOHB4IDE2cHg7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLXNlYXJjaC1ib3JkZXIpOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA2cHg7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWJ1dHRvbi1iZyk7CiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0LWNvbG9yKTsKICAgICAgICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICAgICAgICBmb250LXNpemU6IDE0cHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA1MDA7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjJzIGVhc2U7CiAgICAgICAgICAgIG1pbi13aWR0aDogMTIwcHg7CiAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICB9CgogICAgICAgICNjb250cm9sUGFuZWwgYnV0dG9uOmhvdmVyIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYnV0dG9uLWhvdmVyKTsKICAgICAgICAgICAgYm9yZGVyLWNvbG9yOiB2YXIoLS1saW5rLWNvbG9yKTsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC0xcHgpOwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDJweCA0cHggdmFyKC0tY29udHJvbC1wYW5lbC1zaGFkb3cpOwogICAgICAgIH0KCiAgICAgICAgI2NvbnRyb2xQYW5lbCBidXR0b246YWN0aXZlIHsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDApOwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDFweCAycHggdmFyKC0tY29udHJvbC1wYW5lbC1zaGFkb3cpOwogICAgICAgIH0KCiAgICAgICAgLmNvbnZlcnNhdGlvbiBoNCB7CiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICAgICAgZ2FwOiA4cHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYmFja2dyb3VuZC1jb2xvciAwLjJzIGVhc2U7CiAgICAgICAgfQoKICAgICAgICAuY29udmVyc2F0aW9uIGg0OmhvdmVyIHsKICAgICAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYnV0dG9uLWhvdmVyKTsKICAgICAgICAgICAgcGFkZGluZzogOHB4OwogICAgICAgICAgICBtYXJnaW46IC04cHg7CiAgICAgICAgfQoKICAgICAgICAuY29udmVyc2F0aW9uIGg0IGEgewogICAgICAgICAgICBjb2xvcjogdmFyKC0tbGluay1jb2xvcik7CiAgICAgICAgICAgIHRleHQtZGVjb3JhdGlvbjogbm9uZTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IG5vcm1hbDsKICAgICAgICAgICAgb3BhY2l0eTogMC43OwogICAgICAgICAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuMnMgZWFzZTsKICAgICAgICB9CgogICAgICAgIC5jb252ZXJzYXRpb24gaDQgYTpob3ZlciB7CiAgICAgICAgICAgIG9wYWNpdHk6IDE7CiAgICAgICAgfQoKICAgICAgICAuc3RhdHMgewogICAgICAgICAgICBmb250LXNpemU6IDAuODVlbTsKICAgICAgICAgICAgb3BhY2l0eTogMC43OwogICAgICAgICAgICBtYXJnaW4tbGVmdDogYXV0bzsKICAgICAgICAgICAgdGV4dC1hbGlnbjogcmlnaHQ7CiAgICAgICAgICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICAgICAgfQoKICAgICAgICBAbWVkaWEgKG1heC13aWR0aDogNzY4cHgpIHsKICAgICAgICAgICAgYm9keSB7CiAgICAgICAgICAgICAgICBwYWRkaW5nOiAxMHB4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAjcm9vdCB7CiAgICAgICAgICAgICAgICBtYXJnaW4tdG9wOiA3MHB4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAjY29udHJvbFBhbmVsIHsKICAgICAgICAgICAgICAgIHBhZGRpbmc6IDhweCAxMHB4OwogICAgICAgICAgICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBzdHJldGNoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAjY29udHJvbFBhbmVsIGlucHV0IHsKICAgICAgICAgICAgICAgIG1pbi13aWR0aDogYXV0bzsKICAgICAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDhweDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLmNvbnZlcnNhdGlvbiB7CiAgICAgICAgICAgICAgICBwYWRkaW5nOiAxNXB4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAuc3RhdHMgewogICAgICAgICAgICAgICAgZm9udC1zaXplOiAwLjhlbTsKICAgICAgICAgICAgICAgIHdoaXRlLXNwYWNlOiBub3JtYWw7CiAgICAgICAgICAgICAgICB0ZXh0LWFsaWduOiBsZWZ0OwogICAgICAgICAgICAgICAgbWFyZ2luLWxlZnQ6IDA7CiAgICAgICAgICAgICAgICBtYXJnaW4tdG9wOiA0cHg7CiAgICAgICAgICAgICAgICBkaXNwbGF5OiBibG9jazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIDwvc3R5bGU+CiAgICA8c2NyaXB0Pg==";
        const post = "Ci8qIAogKiBFbmhhbmNlZCBDaGF0R1BUIEFyY2hpdmUgVmlld2VyCiAqIFBvd2VyZWQgYnkgaHR0cHM6Ly9jaGF0Lm9wZW5haS5jb20vCiAqIEVuaGFuY2VkIGJ5IGh0dHBzOi8vc2ltb253YWxkaGVyci5naXRodWIuaW8vY2hhdGdwdC1hcmNoaXZlLXZpZXdlci8KICovCgovLyBFbmhhbmNlZCBjb252ZXJzYXRpb24gbWVzc2FnZSBwYXJzZXIKZnVuY3Rpb24gZ2V0Q29udmVyc2F0aW9uTWVzc2FnZXMoY29udmVyc2F0aW9uKSB7CiAgICBjb25zdCBtZXNzYWdlcyA9IFtdOwogICAgbGV0IGN1cnJlbnROb2RlID0gY29udmVyc2F0aW9uLmN1cnJlbnRfbm9kZTsKICAgIAogICAgd2hpbGUgKGN1cnJlbnROb2RlICE9IG51bGwpIHsKICAgICAgICBjb25zdCBub2RlID0gY29udmVyc2F0aW9uLm1hcHBpbmdbY3VycmVudE5vZGVdOwogICAgICAgIGlmICgKICAgICAgICAgICAgbm9kZS5tZXNzYWdlICYmCiAgICAgICAgICAgIG5vZGUubWVzc2FnZS5jb250ZW50ICYmCiAgICAgICAgICAgIG5vZGUubWVzc2FnZS5jb250ZW50LmNvbnRlbnRfdHlwZSA9PT0gInRleHQiICYmCiAgICAgICAgICAgIG5vZGUubWVzc2FnZS5jb250ZW50LnBhcnRzLmxlbmd0aCA+IDAgJiYKICAgICAgICAgICAgbm9kZS5tZXNzYWdlLmNvbnRlbnQucGFydHNbMF0ubGVuZ3RoID4gMCAmJgogICAgICAgICAgICAobm9kZS5tZXNzYWdlLmF1dGhvci5yb2xlICE9PSAic3lzdGVtIiB8fCBub2RlLm1lc3NhZ2UubWV0YWRhdGE/LmlzX3VzZXJfc3lzdGVtX21lc3NhZ2UpCiAgICAgICAgKSB7CiAgICAgICAgICAgIGxldCBhdXRob3IgPSBub2RlLm1lc3NhZ2UuYXV0aG9yLnJvbGU7CiAgICAgICAgICAgIGlmIChhdXRob3IgPT09ICJhc3Npc3RhbnQiKSB7CiAgICAgICAgICAgICAgICBhdXRob3IgPSAiQ2hhdEdQVCI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXV0aG9yID09PSAic3lzdGVtIiAmJiBub2RlLm1lc3NhZ2UubWV0YWRhdGE/LmlzX3VzZXJfc3lzdGVtX21lc3NhZ2UpIHsKICAgICAgICAgICAgICAgIGF1dGhvciA9ICJDdXN0b20gdXNlciBpbmZvIjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgbWVzc2FnZXMucHVzaCh7IAogICAgICAgICAgICAgICAgYXV0aG9yLCAKICAgICAgICAgICAgICAgIHRleHQ6IG5vZGUubWVzc2FnZS5jb250ZW50LnBhcnRzWzBdLCAKICAgICAgICAgICAgICAgIGRhdGU6IG5ldyBEYXRlKG5vZGUubWVzc2FnZS5jcmVhdGVfdGltZSAqIDEwMDApLAogICAgICAgICAgICAgICAgbWVzc2FnZUlkOiBub2RlLm1lc3NhZ2UuaWQKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGN1cnJlbnROb2RlID0gbm9kZS5wYXJlbnQ7CiAgICB9CiAgICByZXR1cm4gbWVzc2FnZXMucmV2ZXJzZSgpOwp9CgovLyBFbmhhbmNlZCBkYXJrIG1vZGUgc3VwcG9ydApmdW5jdGlvbiBhcHBseURhcmtNb2RlUHJlZmVyZW5jZSgpIHsKICAgIGNvbnN0IHByZWZlcnNEYXJrID0gd2luZG93Lm1hdGNoTWVkaWEgJiYgd2luZG93Lm1hdGNoTWVkaWEoJyhwcmVmZXJzLWNvbG9yLXNjaGVtZTogZGFyayknKS5tYXRjaGVzOwogICAgCiAgICBpZiAocHJlZmVyc0RhcmspIHsKICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5hZGQoJ2RhcmstbW9kZScpOwogICAgfQoKICAgIC8vIExpc3RlbiBmb3IgY2hhbmdlcyBpbiBjb2xvciBzY2hlbWUgcHJlZmVyZW5jZQogICAgaWYgKHdpbmRvdy5tYXRjaE1lZGlhKSB7CiAgICAgICAgd2luZG93Lm1hdGNoTWVkaWEoJyhwcmVmZXJzLWNvbG9yLXNjaGVtZTogZGFyayknKS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBlID0+IHsKICAgICAgICAgICAgaWYgKGUubWF0Y2hlcykgewogICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCdkYXJrLW1vZGUnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgnZGFyay1tb2RlJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KfQoKLy8gVXRpbGl0eSBmdW5jdGlvbiB0byBmb3JtYXQgZGF0ZXMKZnVuY3Rpb24gZm9ybWF0RGF0ZShkYXRlKSB7CiAgICByZXR1cm4gZGF0ZS50b0lTT1N0cmluZygpLnJlcGxhY2UoIlQiLCAiICIpLnN1YnN0cigwLCAxOSk7Cn0KCi8vIFV0aWxpdHkgZnVuY3Rpb24gdG8gZXNjYXBlIEhUTUwgd2l0aCBwcm9wZXIgVVRGLTggaGFuZGxpbmcKZnVuY3Rpb24gZXNjYXBlSHRtbCh0ZXh0KSB7CiAgICBpZiAodHlwZW9mIHRleHQgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgdGV4dCA9IFN0cmluZyh0ZXh0KTsKICAgIH0KICAgIAogICAgLy8gRml4IGNvbW1vbiBlbmNvZGluZyBpc3N1ZXMKICAgIHRleHQgPSB0ZXh0CiAgICAgICAgLnJlcGxhY2UoL8Oi4oKs4oSiL2csICInIikgICAgIC8vIEZpeCBjdXJseSBhcG9zdHJvcGhlCiAgICAgICAgLnJlcGxhY2UoL8Oi4oKsxZMvZywgJyInKSAgICAgLy8gRml4IG9wZW5pbmcgcXVvdGUKICAgICAgICAucmVwbGFjZSgvw6LigqwvZywgJyInKSAgICAgIC8vIEZpeCBjbG9zaW5nIHF1b3RlCiAgICAgICAgLnJlcGxhY2UoL8Oi4oKsIi9nLCAn4oCUJykgICAgIC8vIEZpeCBlbSBkYXNoCiAgICAgICAgLnJlcGxhY2UoL8Oi4oKsIi9nLCAn4oCTJykgICAgIC8vIEZpeCBlbiBkYXNoCiAgICAgICAgLnJlcGxhY2UoL8Oi4oKswqYvZywgJ+KApicpICAgICAvLyBGaXggZWxsaXBzaXMKICAgICAgICAucmVwbGFjZSgvw4IvZywgJycpICAgICAgICAvLyBSZW1vdmUgZXh0cmEgbm9uLWJyZWFraW5nIHNwYWNlIG1hcmtlcnMKICAgICAgICAucmVwbGFjZSgvw6LCoi9nLCAn4oCiJyk7ICAgICAvLyBGaXggYnVsbGV0IHBvaW50CiAgICAKICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgZGl2LnRleHRDb250ZW50ID0gdGV4dDsKICAgIHJldHVybiBkaXYuaW5uZXJIVE1MOwp9CgovLyBGb3JtYXQgZGF0ZSBmb3IgbWVzc2FnZSBoZWFkZXJzIChzaG9ydGVyIGZvcm1hdCkKZnVuY3Rpb24gZm9ybWF0RGF0ZVNob3J0KGRhdGUpIHsKICAgIGlmICghZGF0ZSkgcmV0dXJuICcnOwogICAgY29uc3Qgb3B0aW9ucyA9IHsgCiAgICAgICAgeWVhcjogJ251bWVyaWMnLCAKICAgICAgICBtb250aDogJ3Nob3J0JywgCiAgICAgICAgZGF5OiAnbnVtZXJpYycsCiAgICAgICAgaG91cjogJzItZGlnaXQnLAogICAgICAgIG1pbnV0ZTogJzItZGlnaXQnCiAgICB9OwogICAgcmV0dXJuIGRhdGUudG9Mb2NhbGVEYXRlU3RyaW5nKCdlbi1VUycsIG9wdGlvbnMpOwp9CgovLyBFbmhhbmNlZCBtYWluIGluaXRpYWxpemF0aW9uIGZ1bmN0aW9uCndpbmRvdy5vbmxvYWQgPSBmdW5jdGlvbigpIHsKICAgIHRyeSB7CiAgICAgICAgYnVpbGRDb252ZXJzYXRpb25MaXN0KCk7CiAgICAgICAgc2V0dXBDb250cm9sUGFuZWwoKTsKICAgICAgICBhcHBseURhcmtNb2RlUHJlZmVyZW5jZSgpOwogICAgICAgIAogICAgICAgIC8vIEluaXRpYWwgc3RhdGU6IGNvbGxhcHNlIGFsbCBjb252ZXJzYXRpb25zCiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmNvbnZlcnNhdGlvbicpLmZvckVhY2goZGl2ID0+IHsKICAgICAgICAgICAgZGl2LmNsYXNzTGlzdC5hZGQoJ2NvbGxhcHNlZCcpOwogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIGNvbnNvbGUubG9nKCfinIUgQ2hhdEdQVCBBcmNoaXZlIEVuaGFuY2VkIGxvYWRlZCBzdWNjZXNzZnVsbHknKTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGxvYWRpbmcgQ2hhdEdQVCBBcmNoaXZlOicsIGVycm9yKTsKICAgIH0KfTsKCi8vIEJ1aWxkIHRoZSBjb252ZXJzYXRpb24gbGlzdApmdW5jdGlvbiBidWlsZENvbnZlcnNhdGlvbkxpc3QoKSB7CiAgICBjb25zdCByb290ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJvb3QiKTsKICAgIGlmICghcm9vdCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignUm9vdCBlbGVtZW50IG5vdCBmb3VuZCcpOwogICAgfQogICAgCiAgICByb290LmlubmVySFRNTCA9ICcnOwogICAgCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGpzb25EYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgY29udmVyc2F0aW9uID0ganNvbkRhdGFbaV07CiAgICAgICAgY29uc3QgbWVzc2FnZXMgPSBnZXRDb252ZXJzYXRpb25NZXNzYWdlcyhjb252ZXJzYXRpb24pOwogICAgICAgIAogICAgICAgIGlmIChtZXNzYWdlcy5sZW5ndGggPT09IDApIGNvbnRpbnVlOwogICAgICAgIAogICAgICAgIGNvbnN0IGNvbnZlcnNhdGlvbkRpdiA9IGNyZWF0ZUNvbnZlcnNhdGlvbkVsZW1lbnQoY29udmVyc2F0aW9uLCBtZXNzYWdlcyk7CiAgICAgICAgcm9vdC5hcHBlbmRDaGlsZChjb252ZXJzYXRpb25EaXYpOwogICAgfQp9CgovLyBDcmVhdGUgYSBjb252ZXJzYXRpb24gZWxlbWVudApmdW5jdGlvbiBjcmVhdGVDb252ZXJzYXRpb25FbGVtZW50KGNvbnZlcnNhdGlvbiwgbWVzc2FnZXMpIHsKICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgZGl2LmNsYXNzTmFtZSA9ICJjb252ZXJzYXRpb24iOwogICAgCiAgICAvLyBDYWxjdWxhdGUgc3RhdHMKICAgIGNvbnN0IG1lc3NhZ2VDb3VudCA9IG1lc3NhZ2VzLmxlbmd0aDsKICAgIGNvbnN0IHRvdGFsTGVuZ3RoID0gbWVzc2FnZXMucmVkdWNlKChzdW0sIG1zZykgPT4gc3VtICsgbXNnLnRleHQubGVuZ3RoLCAwKTsKICAgIAogICAgLy8gR2V0IGZpcnN0IGFuZCBsYXN0IG1lc3NhZ2UgZGF0ZXMKICAgIGNvbnN0IGZpcnN0RGF0ZSA9IG1lc3NhZ2VzLmxlbmd0aCA+IDAgPyBtZXNzYWdlc1swXS5kYXRlIDogbnVsbDsKICAgIGNvbnN0IGxhc3REYXRlID0gbWVzc2FnZXMubGVuZ3RoID4gMCA/IG1lc3NhZ2VzW21lc3NhZ2VzLmxlbmd0aCAtIDFdLmRhdGUgOiBudWxsOwogICAgCiAgICAvLyBGb3JtYXQgZGF0ZXMgZm9yIGRpc3BsYXkKICAgIGNvbnN0IGZvcm1hdERhdGUgPSAoZGF0ZSkgPT4gewogICAgICAgIGlmICghZGF0ZSkgcmV0dXJuICcnOwogICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7CiAgICAgICAgY29uc3QgZGlmZlRpbWUgPSBNYXRoLmFicyhub3cgLSBkYXRlKTsKICAgICAgICBjb25zdCBkaWZmRGF5cyA9IE1hdGguY2VpbChkaWZmVGltZSAvICgxMDAwICogNjAgKiA2MCAqIDI0KSk7CiAgICAgICAgCiAgICAgICAgaWYgKGRpZmZEYXlzID09PSAxKSByZXR1cm4gJ3RvZGF5JzsKICAgICAgICBpZiAoZGlmZkRheXMgPT09IDIpIHJldHVybiAneWVzdGVyZGF5JzsKICAgICAgICBpZiAoZGlmZkRheXMgPD0gNykgcmV0dXJuIGAke2RpZmZEYXlzIC0gMX0gZGF5cyBhZ29gOwogICAgICAgIGlmIChkaWZmRGF5cyA8PSAzMCkgcmV0dXJuIGAke01hdGguY2VpbChkaWZmRGF5cyAvIDcpfSB3ZWVrcyBhZ29gOwogICAgICAgIGlmIChkaWZmRGF5cyA8PSAzNjUpIHJldHVybiBgJHtNYXRoLmNlaWwoZGlmZkRheXMgLyAzMCl9IG1vbnRocyBhZ29gOwogICAgICAgIHJldHVybiBgJHtNYXRoLmNlaWwoZGlmZkRheXMgLyAzNjUpfSB5ZWFycyBhZ29gOwogICAgfTsKICAgIAogICAgLy8gQnVpbGQgc3RhdHMgdGV4dAogICAgbGV0IHN0YXRzVGV4dCA9IGAke21lc3NhZ2VDb3VudH0gbWVzc2FnZXMgJiM4MjI2OyAke01hdGgucm91bmQodG90YWxMZW5ndGgvMTAwMCl9ayBjaGFyc2A7CiAgICBpZiAoZmlyc3REYXRlICYmIGxhc3REYXRlKSB7CiAgICAgICAgY29uc3QgZmlyc3REYXRlU3RyID0gZm9ybWF0RGF0ZShmaXJzdERhdGUpOwogICAgICAgIGNvbnN0IGxhc3REYXRlU3RyID0gZm9ybWF0RGF0ZShsYXN0RGF0ZSk7CiAgICAgICAgaWYgKGZpcnN0RGF0ZVN0ciA9PT0gbGFzdERhdGVTdHIpIHsKICAgICAgICAgICAgc3RhdHNUZXh0ICs9IGAgJiM4MjI2OyAke2ZpcnN0RGF0ZVN0cn1gOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXRzVGV4dCArPSBgICYjODIyNjsgJHtmaXJzdERhdGVTdHJ9IHRvICR7bGFzdERhdGVTdHJ9YDsKICAgICAgICB9CiAgICB9CiAgICAKICAgIC8vIENyZWF0ZSBoZWFkZXIKICAgIGNvbnN0IGhlYWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImg0Iik7CiAgICBoZWFkZXIuaW5uZXJIVE1MID0gYAogICAgICAgIDxhIGhyZWY9Imh0dHBzOi8vY2hhdC5vcGVuYWkuY29tL2MvJHtjb252ZXJzYXRpb24uY29udmVyc2F0aW9uX2lkfS8iIAogICAgICAgICAgIHRhcmdldD0iX2JsYW5rIiAKICAgICAgICAgICByZWw9Im5vb3BlbmVyIG5vcmVmZXJyZXIiIAogICAgICAgICAgIHRpdGxlPSJPcGVuIGluIENoYXRHUFQiPiYjMTI4Mjc5OzwvYT4KICAgICAgICA8c3Bhbj4ke2VzY2FwZUh0bWwoY29udmVyc2F0aW9uLnRpdGxlKX08L3NwYW4+CiAgICAgICAgPHNwYW4gY2xhc3M9InN0YXRzIj4ke3N0YXRzVGV4dH08L3NwYW4+CiAgICBgOwogICAgCiAgICAvLyBBZGQgY2xpY2sgaGFuZGxlciB0byBoZWFkZXIKICAgIGhlYWRlci5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKGUpIHsKICAgICAgICBpZiAoZS50YXJnZXQudGFnTmFtZSAhPT0gJ0EnKSB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgdGhpcy5wYXJlbnRFbGVtZW50LmNsYXNzTGlzdC50b2dnbGUoJ2NvbGxhcHNlZCcpOwogICAgICAgIH0KICAgIH0pOwogICAgCiAgICBkaXYuYXBwZW5kQ2hpbGQoaGVhZGVyKTsKICAgIAogICAgLy8gQWRkIG1lc3NhZ2VzCiAgICBtZXNzYWdlcy5mb3JFYWNoKG1lc3NhZ2VEYXRhID0+IHsKICAgICAgICBjb25zdCBtZXNzYWdlRWxlbWVudCA9IGNyZWF0ZU1lc3NhZ2VFbGVtZW50KG1lc3NhZ2VEYXRhKTsKICAgICAgICBkaXYuYXBwZW5kQ2hpbGQobWVzc2FnZUVsZW1lbnQpOwogICAgfSk7CiAgICAKICAgIHJldHVybiBkaXY7Cn0KCi8vIENyZWF0ZSBhIG1lc3NhZ2UgZWxlbWVudApmdW5jdGlvbiBjcmVhdGVNZXNzYWdlRWxlbWVudChtZXNzYWdlRGF0YSkgewogICAgY29uc3QgbWVzc2FnZURpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgbWVzc2FnZURpdi5jbGFzc05hbWUgPSAibWVzc2FnZSI7CiAgICAKICAgIC8vIEFkZCBzcGVjaWZpYyBjbGFzc2VzIGZvciBzdHlsaW5nCiAgICBpZiAobWVzc2FnZURhdGEuYXV0aG9yID09PSAiQ2hhdEdQVCIpIHsKICAgICAgICBtZXNzYWdlRGl2LmNsYXNzTGlzdC5hZGQoImNoYXRncHQtbWVzc2FnZSIpOwogICAgfSBlbHNlIGlmIChtZXNzYWdlRGF0YS5hdXRob3IgPT09ICJ1c2VyIikgewogICAgICAgIG1lc3NhZ2VEaXYuY2xhc3NMaXN0LmFkZCgidXNlci1tZXNzYWdlIik7CiAgICB9CiAgICAKICAgIC8vIFNwZWNpYWwgc3R5bGluZyBmb3IgY3VzdG9tIHVzZXIgaW5mbwogICAgaWYgKG1lc3NhZ2VEYXRhLmF1dGhvciA9PT0gIkN1c3RvbSB1c2VyIGluZm8iKSB7CiAgICAgICAgbWVzc2FnZURpdi5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAidmFyKC0tYnV0dG9uLWJnKSI7CiAgICAgICAgbWVzc2FnZURpdi5zdHlsZS5ib3JkZXIgPSAiMnB4IGRhc2hlZCB2YXIoLS1jb252ZXJzYXRpb24tYm9yZGVyKSI7CiAgICB9CiAgICAKICAgIG1lc3NhZ2VEaXYuaW5uZXJIVE1MID0gYAogICAgICAgIDxkaXYgY2xhc3M9ImF1dGhvciI+JHtlc2NhcGVIdG1sKG1lc3NhZ2VEYXRhLmF1dGhvcil9ICgke2Zvcm1hdERhdGVTaG9ydChtZXNzYWdlRGF0YS5kYXRlKX0pPC9kaXY+CiAgICAgICAgPGRpdj4ke2VzY2FwZUh0bWwobWVzc2FnZURhdGEudGV4dCl9PC9kaXY+CiAgICBgOwogICAgCiAgICByZXR1cm4gbWVzc2FnZURpdjsKfQoKLy8gU2V0dXAgdGhlIGNvbnRyb2wgcGFuZWwKZnVuY3Rpb24gc2V0dXBDb250cm9sUGFuZWwoKSB7CiAgICBjb25zdCBjb250cm9sUGFuZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGNvbnRyb2xQYW5lbC5pZCA9ICdjb250cm9sUGFuZWwnOwogICAgCiAgICAvLyBTZWFyY2ggaW5wdXQKICAgIGNvbnN0IHNlYXJjaEJveCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7CiAgICBzZWFyY2hCb3gudHlwZSA9ICd0ZXh0JzsKICAgIHNlYXJjaEJveC5wbGFjZWhvbGRlciA9ICdTZWFyY2ggY29udmVyc2F0aW9ucy4uLiAodXNlIHF1b3RlcywgLSBmb3IgZXhjbHVkZSwgLyBmb3IgT1IpJzsKICAgIHNlYXJjaEJveC5zZXRBdHRyaWJ1dGUoJ2FyaWEtbGFiZWwnLCAnU2VhcmNoIGNvbnZlcnNhdGlvbnMnKTsKICAgIAogICAgLy8gQnV0dG9ucwogICAgY29uc3Qgc2VhcmNoQnV0dG9uID0gY3JlYXRlQnV0dG9uKCcmIzEyODI2OTsgU2VhcmNoJywgKCkgPT4gcGVyZm9ybVNlYXJjaChzZWFyY2hCb3gudmFsdWUpKTsKICAgIGNvbnN0IGV4cGFuZEFsbEJ1dHRvbiA9IGNyZWF0ZUJ1dHRvbignJiMxMjgyMTQ7IEV4cGFuZCBBbGwnLCBleHBhbmRBbGxDb252ZXJzYXRpb25zKTsKICAgIGNvbnN0IGNvbGxhcHNlQWxsQnV0dG9uID0gY3JlYXRlQnV0dG9uKCcmIzEyODIxODsgQ29sbGFwc2UgQWxsJywgY29sbGFwc2VBbGxDb252ZXJzYXRpb25zKTsKICAgIGNvbnN0IGRhcmtNb2RlQnV0dG9uID0gY3JlYXRlQnV0dG9uKCcmIzEyNzc2OTsgVG9nZ2xlIERhcmsgTW9kZScsIHRvZ2dsZURhcmtNb2RlKTsKICAgIAogICAgLy8gQWRkIGVsZW1lbnRzIHRvIGNvbnRyb2wgcGFuZWwKICAgIFtzZWFyY2hCb3gsIHNlYXJjaEJ1dHRvbiwgZXhwYW5kQWxsQnV0dG9uLCBjb2xsYXBzZUFsbEJ1dHRvbiwgZGFya01vZGVCdXR0b25dLmZvckVhY2goZWxlbWVudCA9PiB7CiAgICAgICAgY29udHJvbFBhbmVsLmFwcGVuZENoaWxkKGVsZW1lbnQpOwogICAgfSk7CiAgICAKICAgIC8vIEFkZCB0byBwYWdlCiAgICBkb2N1bWVudC5ib2R5Lmluc2VydEJlZm9yZShjb250cm9sUGFuZWwsIGRvY3VtZW50LmJvZHkuZmlyc3RDaGlsZCk7CiAgICAKICAgIC8vIFNldHVwIHNlYXJjaCBvbiBFbnRlciBrZXkKICAgIHNlYXJjaEJveC5hZGRFdmVudExpc3RlbmVyKCdrZXlwcmVzcycsIGZ1bmN0aW9uKGUpIHsKICAgICAgICBpZiAoZS5rZXkgPT09ICdFbnRlcicpIHsKICAgICAgICAgICAgcGVyZm9ybVNlYXJjaCh0aGlzLnZhbHVlKTsKICAgICAgICB9CiAgICB9KTsKICAgIAogICAgLy8gQXV0by1zZWFyY2ggYXMgdXNlciB0eXBlcyAoZGVib3VuY2VkKQogICAgbGV0IHNlYXJjaFRpbWVvdXQ7CiAgICBzZWFyY2hCb3guYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBmdW5jdGlvbigpIHsKICAgICAgICBjbGVhclRpbWVvdXQoc2VhcmNoVGltZW91dCk7CiAgICAgICAgc2VhcmNoVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAodGhpcy52YWx1ZS5sZW5ndGggPiAyIHx8IHRoaXMudmFsdWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICBwZXJmb3JtU2VhcmNoKHRoaXMudmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwgMzAwKTsKICAgIH0pOwp9CgovLyBDcmVhdGUgYSBidXR0b24gZWxlbWVudApmdW5jdGlvbiBjcmVhdGVCdXR0b24odGV4dCwgb25DbGljaykgewogICAgY29uc3QgYnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7CiAgICBidXR0b24uaW5uZXJIVE1MID0gdGV4dDsKICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIG9uQ2xpY2spOwogICAgcmV0dXJuIGJ1dHRvbjsKfQovLyBFeHBhbmQgYWxsIGNvbnZlcnNhdGlvbnMKZnVuY3Rpb24gZXhwYW5kQWxsQ29udmVyc2F0aW9ucygpIHsKICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5jb252ZXJzYXRpb24nKS5mb3JFYWNoKGRpdiA9PiB7CiAgICAgICAgZGl2LmNsYXNzTGlzdC5yZW1vdmUoJ2NvbGxhcHNlZCcpOwogICAgfSk7Cn0KCi8vIENvbGxhcHNlIGFsbCBjb252ZXJzYXRpb25zCmZ1bmN0aW9uIGNvbGxhcHNlQWxsQ29udmVyc2F0aW9ucygpIHsKICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5jb252ZXJzYXRpb24nKS5mb3JFYWNoKGRpdiA9PiB7CiAgICAgICAgZGl2LmNsYXNzTGlzdC5hZGQoJ2NvbGxhcHNlZCcpOwogICAgfSk7Cn0KCi8vIFRvZ2dsZSBkYXJrIG1vZGUKZnVuY3Rpb24gdG9nZ2xlRGFya01vZGUoKSB7CiAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC50b2dnbGUoJ2RhcmstbW9kZScpOwogICAgCiAgICAvLyBTYXZlIHByZWZlcmVuY2UgdG8gbG9jYWxTdG9yYWdlCiAgICBjb25zdCBpc0RhcmtNb2RlID0gZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuY29udGFpbnMoJ2RhcmstbW9kZScpOwogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2RhcmtNb2RlJywgaXNEYXJrTW9kZSk7Cn0KCi8vIEVuaGFuY2VkIHNlYXJjaCBmdW5jdGlvbmFsaXR5CmZ1bmN0aW9uIHBlcmZvcm1TZWFyY2goc2VhcmNoVGV4dCkgewogICAgaWYgKCFzZWFyY2hUZXh0LnRyaW0oKSkgewogICAgICAgIC8vIFNob3cgYWxsIGNvbnZlcnNhdGlvbnMgaWYgc2VhcmNoIGlzIGVtcHR5CiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmNvbnZlcnNhdGlvbicpLmZvckVhY2goZGl2ID0+IHsKICAgICAgICAgICAgZGl2LnN0eWxlLmRpc3BsYXkgPSAnJzsKICAgICAgICB9KTsKICAgICAgICByZXR1cm47CiAgICB9CiAgICAKICAgIGNvbnN0IHNlYXJjaFRlcm1zID0gcGFyc2VTZWFyY2hRdWVyeShzZWFyY2hUZXh0LnRvTG93ZXJDYXNlKCkudHJpbSgpKTsKICAgIAogICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmNvbnZlcnNhdGlvbicpLmZvckVhY2goZGl2ID0+IHsKICAgICAgICBjb25zdCB0ZXh0ID0gZGl2LnRleHRDb250ZW50LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgCiAgICAgICAgY29uc3QgbWF0Y2hlc0luY2x1ZGUgPSBzZWFyY2hUZXJtcy5pbmNsdWRlLmxlbmd0aCA9PT0gMCB8fCAKICAgICAgICAgICAgc2VhcmNoVGVybXMuaW5jbHVkZS5ldmVyeSh0ZXJtID0+IHRleHQuaW5jbHVkZXModGVybSkpOwogICAgICAgIAogICAgICAgIGNvbnN0IG1hdGNoZXNPciA9IHNlYXJjaFRlcm1zLm9yLmxlbmd0aCA9PT0gMCB8fCAKICAgICAgICAgICAgc2VhcmNoVGVybXMub3Iuc29tZShncm91cCA9PiBncm91cC5zb21lKHRlcm0gPT4gdGV4dC5pbmNsdWRlcyh0ZXJtKSkpOwogICAgICAgIAogICAgICAgIGNvbnN0IG1hdGNoZXNFeGNsdWRlID0gc2VhcmNoVGVybXMuZXhjbHVkZS5ldmVyeSh0ZXJtID0+ICF0ZXh0LmluY2x1ZGVzKHRlcm0pKTsKICAgICAgICAKICAgICAgICBpZiAobWF0Y2hlc0luY2x1ZGUgJiYgbWF0Y2hlc09yICYmIG1hdGNoZXNFeGNsdWRlKSB7CiAgICAgICAgICAgIGRpdi5zdHlsZS5kaXNwbGF5ID0gJyc7CiAgICAgICAgICAgIC8vIEV4cGFuZCBtYXRjaGluZyBjb252ZXJzYXRpb25zIGZvciBiZXR0ZXIgdmlzaWJpbGl0eQogICAgICAgICAgICBkaXYuY2xhc3NMaXN0LnJlbW92ZSgnY29sbGFwc2VkJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGl2LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQogICAgfSk7Cn0KCi8vIFBhcnNlIHNlYXJjaCBxdWVyeSB3aXRoIGFkdmFuY2VkIG9wZXJhdG9ycwpmdW5jdGlvbiBwYXJzZVNlYXJjaFF1ZXJ5KHNlYXJjaFRleHQpIHsKICAgIGNvbnN0IGluY2x1ZGUgPSBbXTsKICAgIGNvbnN0IGV4Y2x1ZGUgPSBbXTsKICAgIGNvbnN0IG9yID0gW107CiAgICAKICAgIC8vIFJlZ2V4IHRvIGZpbmQgcXVvdGVkIHN0cmluZ3MsIGV4Y2x1ZGUgdGVybXMgKC0pLCBPUiB0ZXJtcyAoLyksIGFuZCBub3JtYWwgdGVybXMKICAgIGNvbnN0IHJlZ2V4ID0gLyIoW14iXSspInwoXFMrKS9nOwogICAgbGV0IG1hdGNoOwogICAgCiAgICB3aGlsZSAoKG1hdGNoID0gcmVnZXguZXhlYyhzZWFyY2hUZXh0KSkgIT09IG51bGwpIHsKICAgICAgICBpZiAobWF0Y2hbMV0pIHsKICAgICAgICAgICAgLy8gUXVvdGVkIHN0cmluZwogICAgICAgICAgICBpbmNsdWRlLnB1c2gobWF0Y2hbMV0pOwogICAgICAgIH0gZWxzZSBpZiAobWF0Y2hbMl0uc3RhcnRzV2l0aCgnLScpKSB7CiAgICAgICAgICAgIC8vIEV4Y2x1ZGUgdGVybQogICAgICAgICAgICBleGNsdWRlLnB1c2gobWF0Y2hbMl0uc2xpY2UoMSkpOwogICAgICAgIH0gZWxzZSBpZiAobWF0Y2hbMl0uaW5jbHVkZXMoJy8nKSkgewogICAgICAgICAgICAvLyBPUiB0ZXJtCiAgICAgICAgICAgIG9yLnB1c2gobWF0Y2hbMl0uc3BsaXQoJy8nKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gTm9ybWFsIGluY2x1ZGUgdGVybQogICAgICAgICAgICBpbmNsdWRlLnB1c2gobWF0Y2hbMl0pOwogICAgICAgIH0KICAgIH0KICAgIAogICAgcmV0dXJuIHsgaW5jbHVkZSwgZXhjbHVkZSwgb3IgfTsKfQoKLy8gTG9hZCBkYXJrIG1vZGUgcHJlZmVyZW5jZQpmdW5jdGlvbiBsb2FkRGFya01vZGVQcmVmZXJlbmNlKCkgewogICAgY29uc3Qgc2F2ZWREYXJrTW9kZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdkYXJrTW9kZScpOwogICAgaWYgKHNhdmVkRGFya01vZGUgPT09ICd0cnVlJykgewogICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCgnZGFyay1tb2RlJyk7CiAgICB9Cn0KCi8vIEluaXRpYWxpemUgb24gcGFnZSBsb2FkCmxvYWREYXJrTW9kZVByZWZlcmVuY2UoKTsKCi8qIEVuaGFuY2VkIGJ5IGh0dHBzOi8vc2ltb253YWxkaGVyci5naXRodWIuaW8vY2hhdGdwdC1hcmNoaXZlLXZpZXdlci8gKi8KICAgIDwvc2NyaXB0Pgo8L2hlYWQ+Cjxib2R5PgogICAgPGRpdiBpZD0icm9vdCI+PC9kaXY+CjwvYm9keT4KPC9odG1sPgogIDwvc2NyaXB0PgogIDwvaGVhZD4KICA8Ym9keT4KICAgIDxkaXYgaWQ9InJvb3QiPjwvZGl2PgogIDwvYm9keT4KPC9odG1sPg==";

        // Utility functions
        function extractJsonLine(inputString) {
            // Ensure the input is properly decoded UTF-8
            if (typeof inputString !== 'string') {
                inputString = String(inputString);
            }
            
            const lines = inputString.split('\n');
            const regex = /^\s*(const|var) jsonData = \[\{/;

            for (let line of lines) {
                if (regex.test(line)) {
                    return line.trim();
                }
            }
            return null;
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            
            const button = document.querySelector('.dark-mode-toggle');
            button.innerHTML = isDarkMode ? '&#9728;' : '&#127769;';
        }

        function showStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }

        // Load dark mode preference
        const savedDarkMode = localStorage.getItem('darkMode');
        if (savedDarkMode === 'true') {
            document.body.classList.add('dark-mode');
            document.querySelector('.dark-mode-toggle').textContent = '‚òÄÔ∏è';
        }

        // File input event handlers
        function handleFileSelection(file) {
            if (file.size > 400 * 1024 * 1024) { // 400MB limit
                alert('File is too large to handle in the browser (max 400MB)');
                return;
            }

            showStatus('Processing your chat archive...', 'loading');

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const content = event.target.result;
                    const chatGPTdata = extractJsonLine(content);

                    if (!chatGPTdata) {
                        throw new Error('No valid ChatGPT data found in file');
                    }

                    const editor = document.getElementById('editor');
                    editor.value = chatGPTdata;
                    
                    hideStatus();
                    document.getElementById('controlPanelAfterUpload').style.display = 'block';
                    showStatus('‚úÖ File processed successfully! You can now save or preview your enhanced archive.', 'success');
                    
                } catch (error) {
                    hideStatus();
                    alert('Error processing file: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                hideStatus();
                alert('Error reading file');
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        // Event listeners
        document.getElementById('file-input').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                handleFileSelection(file);
            }
        });

        document.getElementById('upload-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            if (file) {
                handleFileSelection(file);
            }
        });

        document.getElementById('download-button').addEventListener('click', function() {
            const editedContent = atob(pre) + '\n\n' + document.getElementById('editor').value + '\n\n' + atob(post);
            const blob = new Blob([editedContent], { type: 'text/html; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chatgpt-enhanced.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        document.getElementById('open-button').addEventListener('click', function() {
            const editedContent = atob(pre) + '\n\n' + document.getElementById('editor').value + '\n\n' + atob(post);
            
            // Open in new tab with proper UTF-8 handling
            const newWindow = window.open();
            newWindow.document.open('text/html', 'replace');
            newWindow.document.charset = 'UTF-8';
            newWindow.document.write(editedContent);
            newWindow.document.close();
        });

        // Initialize with system dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches && !localStorage.getItem('darkMode')) {
            document.body.classList.add('dark-mode');
            document.querySelector('.dark-mode-toggle').textContent = '‚òÄÔ∏è';
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js" integrity="sha512-LhccdVNGe2QMEfI3x4DVV3ckMRe36TfydKss6mJpdHjNFiV07dFpS2xzeZedptKZrwxfICJpez09iNioiSZ3hA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>
</html>
